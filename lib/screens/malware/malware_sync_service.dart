import 'package:connectivity_plus/connectivity_plus.dart';
import '../../models/malware_report_model.dart';
import 'malware_local_service.dart';
import 'malware_remote_service.dart';
import 'dart:io';

class MalwareSyncService {
  final MalwareLocalService _localService = MalwareLocalService();
  final MalwareRemoteService _remoteService = MalwareRemoteService();

  Future<Map<String, dynamic>> syncReports() async {
    var connectivity = await Connectivity().checkConnectivity();
    if (connectivity == ConnectivityResult.none) {
      throw Exception('No internet connection available');
    }

    List<MalwareReportModel> reports = await _localService.getAllReports();
    List<MalwareReportModel> unsyncedReports = reports
        .where((r) => !r.isSynced)
        .toList();

    if (unsyncedReports.isEmpty) {
      return {
        'success': true,
        'message': 'No malware reports to sync',
        'syncedCount': 0,
        'failedCount': 0,
      };
    }

    int syncedCount = 0;
    int failedCount = 0;
    List<String> failedReports = [];

    for (var report in unsyncedReports) {
      try {
        // Convert file paths to File objects if needed
        List<File> screenshots = [];
        List<File> documents = [];

        // For malware reports, we might have file attachments
        // This can be extended based on your specific needs

        bool success = await _remoteService.sendReport(
          report,
          screenshots: screenshots.isNotEmpty ? screenshots : null,
          documents: documents.isNotEmpty ? documents : null,
        );
        if (success) {
          report.isSynced = true;
          await _localService.updateReport(report);
          syncedCount++;
        } else {
          failedCount++;
          failedReports.add(report.name);
        }
      } catch (e) {
        failedCount++;
        failedReports.add('${report.name} (Error: $e)');
      }
    }

    return {
      'success': failedCount == 0,
      'message': failedCount == 0
          ? 'Successfully synced $syncedCount malware reports'
          : 'Synced $syncedCount malware reports, $failedCount failed',
      'syncedCount': syncedCount,
      'failedCount': failedCount,
      'failedReports': failedReports,
    };
  }

  Future<int> getUnsyncedCount() async {
    List<MalwareReportModel> reports = await _localService.getAllReports();
    return reports.where((r) => !r.isSynced).length;
  }
}
